<!DOCTYPE html>
<html>
<head>
    <title>Discovery & Coordinate Fixes Test</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px; margin: 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Discovery & Coordinate Fixes Test</h1>

    <div class="test-section">
        <h2>Coordinate System Verification</h2>
        <p>Testing that all objects have proper 3D coordinates in AU scale.</p>
        <button onclick="testCoordinates()">Test Coordinates</button>
        <div id="coordinate-results"></div>
    </div>

    <div class="test-section">
        <h2>Discovery Radius Test</h2>
        <p>Testing that discovery radius is properly scaled to AU (0.01 AU ≈ 1.5M km).</p>
        <button onclick="testDiscoveryRadius()">Test Discovery Radius</button>
        <div id="discovery-results"></div>
    </div>

    <div class="test-section">
        <h2>SOL vs LUNA Position Analysis</h2>
        <p>Comparing SOL and LUNA positions to understand discovery differences.</p>
        <button onclick="analyzeSolLuna()">Analyze SOL & LUNA</button>
        <div id="analysis-results"></div>
    </div>

    <div class="test-section">
        <h2>Hit Box Test</h2>
        <p>Testing ? icon hit box size and clickability improvements.</p>
        <button onclick="testHitBoxes()">Test Hit Boxes</button>
        <div id="hitbox-results"></div>
    </div>

    <div class="test-section">
        <h2>Manual Test Instructions</h2>
        <p>Steps to manually verify the fixes:</p>
        <ol>
            <li>Open the main game</li>
            <li>Navigate to Star Charts (press 'C')</li>
            <li>Clear discoveries: <code>window.navigationSystemManager.starChartsManager.discoveredObjects.clear(); window.navigationSystemManager.starChartsUI.render();</code></li>
            <li>Enable debug: <code>debugEnable('STAR_CHARTS');</code></li>
            <li>Fly around and check debug logs for discovery events</li>
            <li>Click on ? icons and verify zoom functionality</li>
        </ol>
    </div>

    <script>
        async function loadObjectsData() {
            try {
                const response = await fetch('data/star_charts/objects.json');
                return await response.json();
            } catch (error) {
                console.error('Failed to load objects data:', error);
                return null;
            }
        }

        function testCoordinates() {
            const results = document.getElementById('coordinate-results');
            results.innerHTML = '<p class="info">Loading...</p>';

            loadObjectsData().then(data => {
                if (!data) {
                    results.innerHTML = '<p class="error">Failed to load objects data</p>';
                    return;
                }

                let totalObjects = 0;
                let valid3DObjects = 0;
                let invalidObjects = [];

                // Check A0 sector objects
                const a0Sector = data.sectors?.A0;
                if (a0Sector) {
                    // Check celestial objects
                    if (a0Sector.objects) {
                        a0Sector.objects.forEach(obj => {
                            totalObjects++;
                            if (Array.isArray(obj.position) && obj.position.length === 3) {
                                valid3DObjects++;
                            } else {
                                invalidObjects.push(`${obj.id}: ${JSON.stringify(obj.position)}`);
                            }
                        });
                    }

                    // Check infrastructure
                    if (a0Sector.infrastructure) {
                        const allInfra = [
                            ...(a0Sector.infrastructure.stations || []),
                            ...(a0Sector.infrastructure.beacons || [])
                        ];

                        allInfra.forEach(obj => {
                            totalObjects++;
                            if (Array.isArray(obj.position) && obj.position.length === 3) {
                                valid3DObjects++;
                            } else {
                                invalidObjects.push(`${obj.id}: ${JSON.stringify(obj.position)}`);
                            }
                        });
                    }
                }

                let html = `<p><strong>Results:</strong></p>`;
                html += `<p>Total objects: ${totalObjects}</p>`;
                html += `<p>Valid 3D coordinates: ${valid3DObjects}</p>`;
                html += `<p>Invalid coordinates: ${invalidObjects.length}</p>`;

                if (invalidObjects.length === 0) {
                    html += `<p class="success">✅ All objects have valid 3D coordinates!</p>`;
                } else {
                    html += `<p class="error">❌ Objects with invalid coordinates:</p>`;
                    html += `<ul>`;
                    invalidObjects.forEach(obj => {
                        html += `<li>${obj}</li>`;
                    });
                    html += `</ul>`;
                }

                results.innerHTML = html;
            });
        }

        function testDiscoveryRadius() {
            const results = document.getElementById('discovery-results');
            results.innerHTML = '<p class="info">Analyzing discovery radius...</p>';

            loadObjectsData().then(data => {
                if (!data) {
                    results.innerHTML = '<p class="error">Failed to load objects data</p>';
                    return;
                }

                const sol = data.sectors?.A0?.objects?.find(obj => obj.id === 'A0_star');
                const luna = data.sectors?.A0?.objects?.find(obj => obj.id === 'A0_luna');

                if (!sol || !luna) {
                    results.innerHTML = '<p class="error">Could not find SOL or LUNA objects</p>';
                    return;
                }

                const discoveryRadiusAU = 0.01; // Our new discovery radius
                const discoveryRadiusKm = discoveryRadiusAU * 150000000; // Convert to km

                // Calculate distance from camera position [0, 20, 3] to SOL [0, 0, 0]
                const cameraPos = [0, 20, 3];
                const solPos = sol.position;
                const distanceToSol = Math.sqrt(
                    Math.pow(cameraPos[0] - solPos[0], 2) +
                    Math.pow(cameraPos[1] - solPos[1], 2) +
                    Math.pow(cameraPos[2] - solPos[2], 2)
                );

                // Calculate distance from camera to LUNA
                const lunaPos = luna.position;
                const distanceToLuna = Math.sqrt(
                    Math.pow(cameraPos[0] - lunaPos[0], 2) +
                    Math.pow(cameraPos[1] - lunaPos[1], 2) +
                    Math.pow(cameraPos[2] - lunaPos[2], 2)
                );

                let html = `<p><strong>Discovery Radius Analysis:</strong></p>`;
                html += `<p>Discovery radius: ${discoveryRadiusAU} AU (${discoveryRadiusKm.toLocaleString()} km)</p>`;
                html += `<p>SOL position: [${solPos.join(', ')}]</p>`;
                html += `<p>LUNA position: [${lunaPos.join(', ')}]</p>`;
                html += `<p>Camera position: [${cameraPos.join(', ')}]</p>`;
                html += `<p>Distance to SOL: ${distanceToSol.toFixed(3)} AU</p>`;
                html += `<p>Distance to LUNA: ${distanceToLuna.toFixed(3)} AU</p>`;

                if (distanceToSol <= discoveryRadiusAU) {
                    html += `<p class="success">✅ SOL should be discoverable (${distanceToSol.toFixed(3)} AU ≤ ${discoveryRadiusAU} AU)</p>`;
                } else {
                    html += `<p class="error">❌ SOL too far (${distanceToSol.toFixed(3)} AU > ${discoveryRadiusAU} AU)</p>`;
                }

                if (distanceToLuna <= discoveryRadiusAU) {
                    html += `<p class="success">✅ LUNA should be discoverable (${distanceToLuna.toFixed(3)} AU ≤ ${discoveryRadiusAU} AU)</p>`;
                } else {
                    html += `<p class="info">ℹ️ LUNA too far (${distanceToLuna.toFixed(3)} AU > ${discoveryRadiusAU} AU) - expected</p>`;
                }

                results.innerHTML = html;
            });
        }

        function analyzeSolLuna() {
            const results = document.getElementById('analysis-results');
            results.innerHTML = '<p class="info">Analyzing SOL vs LUNA...</p>';

            loadObjectsData().then(data => {
                if (!data) {
                    results.innerHTML = '<p class="error">Failed to load objects data</p>';
                    return;
                }

                const sol = data.sectors?.A0?.objects?.find(obj => obj.id === 'A0_star');
                const luna = data.sectors?.A0?.objects?.find(obj => obj.id === 'A0_luna');

                if (!sol || !luna) {
                    results.innerHTML = '<p class="error">Could not find SOL or LUNA objects</p>';
                    return;
                }

                const distance = Math.sqrt(
                    Math.pow(luna.position[0] - sol.position[0], 2) +
                    Math.pow(luna.position[1] - sol.position[1], 2) +
                    Math.pow(luna.position[2] - sol.position[2], 2)
                );

                let html = `<p><strong>SOL vs LUNA Analysis:</strong></p>`;
                html += `<p>SOL: ${sol.name} at [${sol.position.join(', ')}]</p>`;
                html += `<p>LUNA: ${luna.name} at [${luna.position.join(', ')}]</p>`;
                html += `<p>Distance between SOL and LUNA: ${distance.toFixed(6)} AU</p>`;
                html += `<p>Expected Earth-Moon distance: ~0.0026 AU (384,400 km)</p>`;

                if (Math.abs(distance - 0.0026) < 0.0001) {
                    html += `<p class="success">✅ Distance matches expected Earth-Moon distance</p>`;
                } else {
                    html += `<p class="info">ℹ️ Distance differs from expected (this may be intentional for gameplay)</p>`;
                }

                html += `<p><strong>Discovery Logic:</strong></p>`;
                html += `<p>• SOL is at origin [0,0,0] - easiest to discover</p>`;
                html += `<p>• LUNA is ${distance.toFixed(6)} AU from SOL</p>`;
                html += `<p>• Player starts near SOL, so SOL gets discovered first</p>`;
                html += `<p>• LUNA requires moving away from SOL toward Terra Prime</p>`;

                results.innerHTML = html;
            });
        }

        function testHitBoxes() {
            const results = document.getElementById('hitbox-results');
            results.innerHTML = `
                <p><strong>Hit Box Improvements:</strong></p>
                <ul>
                    <li>✅ Increased minimum hit box size from 32px to 60px</li>
                    <li>✅ Increased multiplier from 1.8x to 3.0x font size</li>
                    <li>✅ Added 'starchart-hitbox' class for proper interaction detection</li>
                    <li>✅ Added 'data-name' attribute for click handling</li>
                    <li>✅ Improved tooltip text</li>
                    <li>✅ Added console logging for click events</li>
                </ul>
                <p><strong>To test:</strong></p>
                <ol>
                    <li>Open Star Charts view</li>
                    <li>Look for ? icons representing undiscovered objects</li>
                    <li>Try clicking on them - they should zoom to that location</li>
                    <li>Check browser console for click confirmation messages</li>
                </ol>
            `;
        }

        // Auto-run coordinate test on load
        window.addEventListener('load', () => {
            setTimeout(testCoordinates, 500);
        });
    </script>
</body>
</html>
