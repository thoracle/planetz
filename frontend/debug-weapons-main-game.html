<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Game Weapons Debugger</title>
    <style>
        body {
            margin: 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff41;
            font-family: "Courier New", monospace;
            font-size: 12px;
        }
        #debug-panel {
            border: 1px solid #00ff41;
            padding: 10px;
            margin: 5px 0;
            background: rgba(0, 0, 0, 0.95);
            max-width: 400px;
        }
        .status-good { color: #00ff41; }
        .status-warning { color: #ffaa00; }
        .status-error { color: #ff4400; }
        .debug-section { margin: 8px 0; border-left: 2px solid #333; padding-left: 8px; }
        button {
            background: #003300;
            color: #00ff41;
            border: 1px solid #00ff41;
            padding: 4px 8px;
            margin: 2px;
            cursor: pointer;
            font-family: "Courier New", monospace;
            font-size: 10px;
        }
        button:hover { background: #004400; }
        #live-debug {
            font-size: 10px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #333;
            padding: 5px;
            background: rgba(0, 0, 0, 0.8);
        }
    </style>
</head>
<body>
    <div id="debug-panel">
        <h4>üî´ Main Game Weapons Debugger</h4>
        
        <div class="debug-section">
            <strong>Weapons System Status:</strong>
            <div id="weapons-status">Waiting for main game...</div>
        </div>
        
        <div style="margin: 10px 0;">
            <button id="inspect-btn">üîç Inspect Weapons</button>
            <button id="reset-cooldown-btn">‚è∞ Reset Cooldown</button>
            <button id="force-fire-btn">üî´ Force Fire Test</button>
        </div>
        
        <div class="debug-section">
            <strong>Live Debug Log:</strong>
            <div id="live-debug"></div>
        </div>
        
        <div style="margin-top: 10px; font-size: 10px; color: #666;">
            <strong>Instructions:</strong><br>
            1. Load this page in a new tab/window<br>
            2. Keep your main game open<br>
            3. Click "Inspect Weapons" to check status<br>
            4. Try firing in main game and watch debug info
        </div>
    </div>

    <script>
        const weaponsStatus = document.getElementById('weapons-status');
        const liveDebug = document.getElementById('live-debug');
        const inspectBtn = document.getElementById('inspect-btn');
        const resetCooldownBtn = document.getElementById('reset-cooldown-btn');
        const forceFireBtn = document.getElementById('force-fire-btn');
        
        let debugCount = 0;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'success' ? '#00ff41' : 
                         type === 'error' ? '#ff4400' : 
                         type === 'warning' ? '#ffaa00' : '#ffffff';
            
            const div = document.createElement('div');
            div.style.color = color;
            div.innerHTML = `[${timestamp}] ${message}`;
            
            liveDebug.appendChild(div);
            
            // Keep only last 20 messages
            while (liveDebug.children.length > 20) {
                liveDebug.removeChild(liveDebug.firstChild);
            }
            
            liveDebug.scrollTop = liveDebug.scrollHeight;
        }
        
        function getMainGameWeapons() {
            // Try to access the main game's weapons system through various possible global variables
            let weapons = null;
            let ship = null;
            let viewManager = null;
            
            // Check different possible ways the main game might expose these objects
            const possibleGlobals = ['viewManager', 'game', 'app', 'window.viewManager', 'window.game'];
            
            // Try window.viewManager first (most likely)
            if (window.opener && window.opener.viewManager) {
                viewManager = window.opener.viewManager;
                ship = viewManager.ship;
                weapons = ship.systems.get('weapons');
                log('‚úÖ Found weapons via window.opener.viewManager', 'success');
            }
            // Try parent window if this is in an iframe
            else if (window.parent && window.parent.viewManager) {
                viewManager = window.parent.viewManager;
                ship = viewManager.ship;
                weapons = ship.systems.get('weapons');
                log('‚úÖ Found weapons via window.parent.viewManager', 'success');
            }
            // Try direct access if same origin
            else {
                log('‚ùå Cannot access main game weapons - try opening this in a new tab while game is running', 'error');
                return { weapons: null, ship: null, viewManager: null };
            }
            
            return { weapons, ship, viewManager };
        }
        
        function inspectWeapons() {
            debugCount++;
            log(`üîç Inspection #${debugCount}:`);
            
            const { weapons, ship, viewManager } = getMainGameWeapons();
            
            if (!weapons) {
                weaponsStatus.innerHTML = `
                    <div class="status-error">‚ùå Cannot access main game weapons system</div>
                    <div style="font-size: 10px; margin-top: 5px;">
                        Make sure:<br>
                        ‚Ä¢ Main game is running in another tab<br>
                        ‚Ä¢ Both tabs are on same domain<br>
                        ‚Ä¢ Try opening this page from main game console with:<br>
                        <code>window.open('debug-weapons-main-game.html')</code>
                    </div>
                `;
                log('‚ùå No weapons system found', 'error');
                return;
            }
            
            // Get detailed status
            const now = Date.now();
            const weaponsStatus_obj = weapons.getStatus();
            const shipStatus = ship.getStatus();
            const isOperational = weapons.isOperational();
            const canFire = weapons.canFire();
            const cooldownRemaining = weapons.currentCooldown || 0;
            const timeSinceLastFire = now - weapons.lastFireTime;
            const requiredCooldown = weapons.getShotCooldown();
            
            log(`System operational: ${isOperational}`);
            log(`Can fire: ${canFire}`);
            log(`Time since last fire: ${timeSinceLastFire}ms`);
            log(`Required cooldown: ${requiredCooldown}ms`);
            log(`Cooldown remaining: ${cooldownRemaining}ms`);
            log(`Ship energy: ${ship.currentEnergy}/${ship.maxEnergy}`);
            log(`Energy per shot: ${weapons.getEnergyPerShot()}`);
            
            weaponsStatus.innerHTML = `
                <div>Operational: <span class="${isOperational ? 'status-good' : 'status-error'}">${isOperational ? 'YES' : 'NO'}</span></div>
                <div>Can Fire: <span class="${canFire ? 'status-good' : 'status-error'}">${canFire ? 'YES' : 'NO'}</span></div>
                <div>Health: <span class="${weaponsStatus_obj.healthPercentage > 0.5 ? 'status-good' : 'status-warning'}">${(weaponsStatus_obj.healthPercentage * 100).toFixed(1)}%</span></div>
                <div>Ship Energy: <span class="${ship.currentEnergy >= weapons.getEnergyPerShot() ? 'status-good' : 'status-error'}">${ship.currentEnergy.toFixed(1)}</span></div>
                <div>Last Fire Time: <span class="status-good">${weapons.lastFireTime}</span></div>
                <div>Time Since Fire: <span class="${timeSinceLastFire >= requiredCooldown ? 'status-good' : 'status-warning'}">${timeSinceLastFire}ms</span></div>
                <div>Required Cooldown: <span class="status-good">${requiredCooldown}ms</span></div>
                <div>Current Cooldown: <span class="${cooldownRemaining <= 0 ? 'status-good' : 'status-error'}">${cooldownRemaining}ms</span></div>
                <div>Fire Rate: <span class="status-good">${weaponsStatus_obj.currentFireRate}/sec</span></div>
                <div>Weapon Type: <span class="status-good">${weaponsStatus_obj.weaponType}</span></div>
            `;
            
            // Check for specific issues
            if (!isOperational) {
                log('‚ùå ISSUE: Weapon system not operational!', 'error');
            }
            if (ship.currentEnergy < weapons.getEnergyPerShot()) {
                log('‚ùå ISSUE: Insufficient energy!', 'error');
            }
            if (cooldownRemaining > 0) {
                log(`‚ùå ISSUE: Weapon on cooldown for ${cooldownRemaining}ms`, 'error');
            }
            if (timeSinceLastFire < requiredCooldown) {
                log(`‚ùå ISSUE: Not enough time since last fire (${timeSinceLastFire}ms < ${requiredCooldown}ms)`, 'error');
            }
            
            // Store references for button functions
            window.debugWeapons = weapons;
            window.debugShip = ship;
        }
        
        function resetCooldown() {
            if (window.debugWeapons) {
                window.debugWeapons.lastFireTime = 0;
                window.debugWeapons.currentCooldown = 0;
                log('üîÑ Cooldown reset in main game', 'success');
                inspectWeapons(); // Re-inspect to show updated status
            } else {
                log('‚ùå No weapons system to reset', 'error');
            }
        }
        
        function forceFireTest() {
            if (window.debugWeapons && window.debugShip) {
                log('üî´ Attempting force fire test...');
                const fireResult = window.debugWeapons.fire(window.debugShip);
                if (fireResult) {
                    log(`‚úÖ Force fire SUCCESS: ${fireResult.damage} damage`, 'success');
                } else {
                    log('‚ùå Force fire FAILED', 'error');
                }
                inspectWeapons(); // Re-inspect to show updated status
            } else {
                log('‚ùå No weapons system to test', 'error');
            }
        }
        
        // Event listeners
        inspectBtn.addEventListener('click', inspectWeapons);
        resetCooldownBtn.addEventListener('click', resetCooldown);
        forceFireBtn.addEventListener('click', forceFireTest);
        
        // Auto-inspect every 2 seconds if we have weapons
        setInterval(() => {
            if (window.debugWeapons) {
                inspectWeapons();
            }
        }, 2000);
        
        // Initialize
        log('üöÄ Main game weapons debugger ready', 'success');
        log('Click "Inspect Weapons" to start debugging', 'info');
        
        // Try to connect immediately
        setTimeout(inspectWeapons, 1000);
    </script>
</body>
</html> 