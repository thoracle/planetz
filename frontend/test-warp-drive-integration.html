<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WarpDrive System Integration Test</title>
    <style>
        body { 
            margin: 0; 
            padding: 20px; 
            font-family: 'Courier New', monospace; 
            background: #000; 
            color: #00ff41; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        .test-section { 
            margin-bottom: 30px; 
            padding: 20px; 
            border: 1px solid #00ff41; 
            background: rgba(0, 255, 65, 0.1); 
        }
        .test-controls button {
            background: #000;
            color: #00ff41;
            border: 1px solid #00ff41;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-family: inherit;
        }
        .test-controls button:hover {
            background: rgba(0, 255, 65, 0.2);
        }
        #console {
            background: #000;
            border: 1px solid #00ff41;
            padding: 15px;
            height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .status-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .status-card {
            border: 1px solid #00ff41;
            padding: 15px;
            background: rgba(0, 255, 65, 0.05);
        }
        .status-card h3 {
            margin-top: 0;
            color: #00ff41;
        }
        .status-value {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 WarpDrive System Integration Test</h1>
        
        <div class="test-section">
            <h2>Test Controls</h2>
            <div class="test-controls">
                <button onclick="runBasicIntegrationTest()">Run Basic Integration Test</button>
                <button onclick="runLevelCapabilitiesTest()">Test Level Capabilities</button>
                <button onclick="runDamageEffectsTest()">Test Damage Effects</button>
                <button onclick="runAdapterCompatibilityTest()">Test Adapter Compatibility</button>
                <button onclick="runAllTests()">Run All Tests</button>
                <button onclick="clearConsole()">Clear Console</button>
            </div>
        </div>
        
        <div class="test-section">
            <h2>Ship & WarpDrive Status</h2>
            <div class="status-display" id="statusDisplay">
                <!-- Status cards will be populated here -->
            </div>
        </div>
        
        <div class="test-section">
            <h2>Test Console Output</h2>
            <div id="console"></div>
        </div>
    </div>

    <script type="module">
        // Import test functions
        import { testWarpDriveIntegration, testWarpDriveAdapter, runAllWarpDriveTests } from './static/js/ship/WarpDriveIntegrationTest.js';
        
        let ship = null;
        let warpDrive = null;
        let adapter = null;
        
        // Console output capture
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        const originalConsoleTable = console.table;
        
        const consoleElement = document.getElementById('console');
        
        function appendToConsole(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            const prefix = type === 'error' ? '❌ ' : type === 'warn' ? '⚠️ ' : '';
            consoleElement.textContent += `[${timestamp}] ${prefix}${message}\n`;
            consoleElement.scrollTop = consoleElement.scrollHeight;
            
            // Also call original console method
            switch(type) {
                case 'error': originalConsoleError(...args); break;
                case 'warn': originalConsoleWarn(...args); break;
                case 'table': originalConsoleTable(...args); break;
                default: originalConsoleLog(...args); break;
            }
        }
        
        // Override console methods
        console.log = (...args) => appendToConsole('log', ...args);
        console.error = (...args) => appendToConsole('error', ...args);
        console.warn = (...args) => appendToConsole('warn', ...args);
        console.table = (data) => {
            appendToConsole('table', 'Table:', JSON.stringify(data, null, 2));
            originalConsoleTable(data);
        };
        
        // Test functions
        window.runBasicIntegrationTest = async function() {
            console.log('🧪 Starting Basic Integration Test...');
            try {
                await testWarpDriveIntegration();
                await initializeShipForStatus();
                updateStatusDisplay();
            } catch (error) {
                console.error('Basic integration test failed:', error);
            }
        };
        
        window.runLevelCapabilitiesTest = async function() {
            console.log('🧪 Starting Level Capabilities Test...');
            if (!ship || !warpDrive) {
                await initializeShipForStatus();
            }
            
            if (warpDrive) {
                console.log('\n=== Testing WarpDrive Level Capabilities ===');
                for (let level = 1; level <= 5; level++) {
                    warpDrive.level = level;
                    warpDrive.levelStats = warpDrive.initializeLevelStats();
                    
                    console.log(`\nLevel ${level}:`);
                    console.log(`  Max Warp Factor: ${warpDrive.getMaxWarpFactor()}`);
                    console.log(`  Cooldown Time: ${warpDrive.getEffectiveCooldownTime() / 1000}s`);
                    console.log(`  Energy Efficiency: ${((warpDrive.levelStats[level]?.energyEfficiency || 1) * 100).toFixed(0)}%`);
                }
                // Reset to level 1
                warpDrive.level = 1;
                warpDrive.levelStats = warpDrive.initializeLevelStats();
                updateStatusDisplay();
            }
        };
        
        window.runDamageEffectsTest = async function() {
            console.log('🧪 Starting Damage Effects Test...');
            if (!ship || !warpDrive) {
                await initializeShipForStatus();
            }
            
            if (warpDrive) {
                // Repair to full health first
                warpDrive.repair(1.0);
                console.log('\n=== Testing WarpDrive Damage Effects ===');
                console.log('Starting with full health...');
                
                const damageSteps = [0.3, 0.5, 0.8, 1.0];
                for (const damage of damageSteps) {
                    warpDrive.takeDamage(warpDrive.maxHealth * damage);
                    console.log(`\nAfter ${(damage * 100).toFixed(0)}% total damage:`);
                    console.log(`  Health: ${(warpDrive.healthPercentage * 100).toFixed(1)}%`);
                    console.log(`  State: ${warpDrive.state}`);
                    console.log(`  Max Warp Factor: ${warpDrive.getMaxWarpFactor()}`);
                    console.log(`  Effectiveness: ${(warpDrive.getEffectiveness() * 100).toFixed(1)}%`);
                    console.log(`  Can Operate: ${warpDrive.isOperational()}`);
                    
                    if (damage === 1.0) {
                        // Full repair after complete damage
                        warpDrive.repair(1.0);
                        console.log('\nAfter full repair:');
                        console.log(`  Health: ${(warpDrive.healthPercentage * 100).toFixed(1)}%`);
                        console.log(`  State: ${warpDrive.state}`);
                    }
                }
                updateStatusDisplay();
            }
        };
        
        window.runAdapterCompatibilityTest = async function() {
            console.log('🧪 Starting Adapter Compatibility Test...');
            await testWarpDriveAdapter();
        };
        
        window.runAllTests = async function() {
            console.log('🧪 Starting All WarpDrive Tests...');
            try {
                await runAllWarpDriveTests();
                await initializeShipForStatus();
                updateStatusDisplay();
            } catch (error) {
                console.error('All tests failed:', error);
            }
        };
        
        window.clearConsole = function() {
            consoleElement.textContent = '';
        };
        
        // Initialize ship for status display
        async function initializeShipForStatus() {
            try {
                const { default: Ship } = await import('./static/js/ship/Ship.js');
                ship = new Ship('heavy_fighter');
                
                // Wait for async system initialization
                return new Promise((resolve) => {
                    setTimeout(() => {
                        warpDrive = ship.getWarpDrive();
                        console.log('Ship and WarpDrive initialized for status display');
                        resolve();
                    }, 150);
                });
            } catch (error) {
                console.error('Failed to initialize ship for status:', error);
            }
        }
        
        // Update status display
        function updateStatusDisplay() {
            const statusDisplay = document.getElementById('statusDisplay');
            
            if (!ship || !warpDrive) {
                statusDisplay.innerHTML = '<div class="status-card"><h3>No Ship/WarpDrive Available</h3><p>Run a test first to initialize the ship.</p></div>';
                return;
            }
            
            const shipStatus = ship.getStatus();
            const warpStatus = warpDrive.getStatus();
            
            statusDisplay.innerHTML = `
                <div class="status-card">
                    <h3>🚀 Ship Status</h3>
                    <div class="status-value"><span>Type:</span><span>${shipStatus.shipType}</span></div>
                    <div class="status-value"><span>Hull:</span><span>${shipStatus.hull.current}/${shipStatus.hull.max} (${shipStatus.hull.percentage.toFixed(1)}%)</span></div>
                    <div class="status-value"><span>Energy:</span><span>${shipStatus.energy.current.toFixed(0)}/${shipStatus.energy.max} (${shipStatus.energy.percentage.toFixed(1)}%)</span></div>
                    <div class="status-value"><span>Systems:</span><span>${shipStatus.systemCount}</span></div>
                    <div class="status-value"><span>Energy Usage:</span><span>${ship.getEnergyConsumptionRate().toFixed(1)}/sec</span></div>
                </div>
                
                <div class="status-card">
                    <h3>⚡ WarpDrive System</h3>
                    <div class="status-value"><span>Level:</span><span>${warpStatus.level}</span></div>
                    <div class="status-value"><span>Health:</span><span>${(warpStatus.health.percentage * 100).toFixed(1)}%</span></div>
                    <div class="status-value"><span>State:</span><span>${warpStatus.state}</span></div>
                    <div class="status-value"><span>Operational:</span><span>${warpDrive.isOperational() ? '✅' : '❌'}</span></div>
                    <div class="status-value"><span>Effectiveness:</span><span>${(warpStatus.effectiveness * 100).toFixed(1)}%</span></div>
                </div>
                
                <div class="status-card">
                    <h3>🌌 Warp Capabilities</h3>
                    <div class="status-value"><span>Current Factor:</span><span>${warpStatus.warpFactor}</span></div>
                    <div class="status-value"><span>Max Factor:</span><span>${warpStatus.maxWarpFactor}</span></div>
                    <div class="status-value"><span>Is Warping:</span><span>${warpStatus.isWarping ? '✅' : '❌'}</span></div>
                    <div class="status-value"><span>Can Warp:</span><span>${warpStatus.canWarp ? '✅' : '❌'}</span></div>
                    <div class="status-value"><span>Cooldown:</span><span>${(warpStatus.cooldownTime / 1000).toFixed(1)}s</span></div>
                </div>
                
                <div class="status-card">
                    <h3>🔧 System Details</h3>
                    <div class="status-value"><span>Slot Cost:</span><span>${warpStatus.slotCost}</span></div>
                    <div class="status-value"><span>Energy Cost:</span><span>${warpStatus.totalEnergyCost || 'N/A'}</span></div>
                    <div class="status-value"><span>Energy Consumed:</span><span>${warpStatus.energyConsumed || 0}</span></div>
                    <div class="status-value"><span>Current Speed:</span><span>${warpStatus.currentSpeed}</span></div>
                </div>
            `;
        }
        
        // Initial setup
        console.log('🚀 WarpDrive Integration Test Page Loaded');
        console.log('Click the test buttons above to run various tests');
        console.log('The status display will update after running tests');
        
        // Auto-run basic test after a short delay
        setTimeout(() => {
            console.log('\n🔄 Auto-running basic integration test...');
            runBasicIntegrationTest();
        }, 1000);
    </script>
</body>
</html> 