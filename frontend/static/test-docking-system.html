<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docking System Test</title>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: "Courier New", monospace;
            background: #000;
            color: #00ff41;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            border-bottom: 2px solid #00ff41;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .test-section {
            background: rgba(0, 255, 65, 0.1);
            border: 1px solid #00ff41;
            margin: 20px 0;
            padding: 20px;
            border-radius: 5px;
        }
        
        .test-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .control-group {
            background: rgba(0, 255, 65, 0.05);
            border: 1px solid #00aa41;
            padding: 15px;
            border-radius: 3px;
        }
        
        .control-group h4 {
            margin: 0 0 10px 0;
            color: #ffffff;
        }
        
        button {
            background: #00aa41;
            color: #000;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            font-family: "Courier New", monospace;
            font-weight: bold;
            border-radius: 3px;
            margin: 5px;
            transition: all 0.2s ease;
        }
        
        button:hover {
            background: #00ff41;
            transform: scale(1.05);
        }
        
        button:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-display {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ff41;
            padding: 15px;
            margin: 10px 0;
            border-radius: 3px;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .validation-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        
        .validation-success {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid #00ff00;
        }
        
        .validation-failure {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff0000;
            color: #ff6666;
        }
        
        .validation-warning {
            background: rgba(255, 255, 0, 0.2);
            border: 1px solid #ffff00;
            color: #ffff66;
        }
        
        .console-output {
            background: #000;
            border: 1px solid #00ff41;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-size: 11px;
            line-height: 1.3;
            margin-top: 20px;
        }
        
        .log-entry {
            margin: 2px 0;
        }
        
        .log-error { color: #ff6666; }
        .log-warn { color: #ffff66; }
        .log-info { color: #66ffff; }
        .log-success { color: #66ff66; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ DOCKING SYSTEM TEST</h1>
            <p>Comprehensive testing of ship docking system checks and validation</p>
        </div>

        <div class="test-section">
            <h2>Ship Status</h2>
            <div id="shipStatus" class="status-display">
                Initializing ship systems...
            </div>
        </div>

        <div class="test-section">
            <h2>Docking System Controls</h2>
            <div class="test-controls">
                <div class="control-group">
                    <h4>Ship Condition</h4>
                    <button onclick="setShipEnergy(100)">Full Energy</button>
                    <button onclick="setShipEnergy(25)">Low Energy</button>
                    <button onclick="setShipEnergy(10)">Critical Energy</button>
                    <button onclick="damageHull(50)">Damage Hull 50%</button>
                    <button onclick="damageHull(90)">Critical Hull</button>
                    <button onclick="repairShip()">Repair Ship</button>
                </div>
                
                <div class="control-group">
                    <h4>System Status</h4>
                    <button onclick="damageSystem('impulse_engines')">Damage Engines</button>
                    <button onclick="repairSystem('impulse_engines')">Repair Engines</button>
                    <button onclick="damageSystem('shields')">Damage Shields</button>
                    <button onclick="repairSystem('shields')">Repair Shields</button>
                </div>
                
                <div class="control-group">
                    <h4>Ship Movement</h4>
                    <button onclick="setSpeed(1)">Impulse 1</button>
                    <button onclick="setSpeed(3)">Impulse 3</button>
                    <button onclick="setSpeed(5)">Impulse 5</button>
                    <button onclick="setSpeed(9)">Impulse 9</button>
                </div>
                
                <div class="control-group">
                    <h4>Docking Tests</h4>
                    <button onclick="testDockingValidation()">Test Validation</button>
                    <button onclick="testLaunchValidation()">Test Launch</button>
                    <button onclick="simulateDocking()">Simulate Dock</button>
                    <button onclick="simulateUndocking()">Simulate Launch</button>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>Validation Results</h2>
            <div id="validationResults" class="status-display">
                Click "Test Validation" to see docking system checks
            </div>
        </div>

        <div class="test-section">
            <h2>Docking Requirements</h2>
            <div id="dockingRequirements" class="status-display">
                Loading docking requirements...
            </div>
        </div>

        <div class="test-section">
            <h2>Test Console Output</h2>
            <div id="consoleOutput" class="console-output"></div>
        </div>
    </div>

    <script type="module">
        // Import required modules
        const { default: Ship } = await import('./js/ship/Ship.js');
        const { default: DockingSystemManager } = await import('./js/ship/DockingSystemManager.js');
        
        // Global variables
        let ship = null;
        let dockingSystemManager = null;
        let mockStarfieldManager = null;
        let mockTarget = null;
        
        // Initialize systems
        async function initializeSystems() {
            try {
                appendToConsole('üöÄ Docking System Test Page Loaded', 'info');
                appendToConsole('Initializing ship and docking systems...', 'info');
                
                // Create ship instance
                ship = new Ship('heavy_fighter');
                
                // Wait for ship systems to initialize
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Create docking system manager
                dockingSystemManager = new DockingSystemManager();
                
                // Create mock starfield manager
                mockStarfieldManager = createMockStarfieldManager();
                
                // Create mock target
                mockTarget = createMockTarget();
                
                appendToConsole('‚úÖ Systems initialized successfully', 'success');
                
                // Update displays
                updateShipStatus();
                updateDockingRequirements();
                
                appendToConsole('üéØ Ready for testing!', 'info');
                appendToConsole('üìù Use the controls above to test docking system validation', 'info');
                
            } catch (error) {
                appendToConsole(`‚ùå Failed to initialize systems: ${error.message}`, 'error');
                console.error('Initialization error:', error);
            }
        }
        
        // Create mock starfield manager for testing
        function createMockStarfieldManager() {
            return {
                isDocked: false,
                currentSpeed: 1,
                currentTarget: null,
                targetComputerEnabled: false,
                camera: {
                    position: { x: 0, y: 0, z: 0 }
                },
                calculateDistance: (pos1, pos2) => {
                    const dx = pos1.x - pos2.x;
                    const dy = pos1.y - pos2.y;
                    const dz = pos1.z - pos2.z;
                    return Math.sqrt(dx*dx + dy*dy + dz*dz);
                },
                solarSystemManager: {
                    getCelestialBodyInfo: (target) => ({
                        name: 'Test Planet',
                        type: 'planet',
                        diplomacy: 'neutral',
                        size: 'medium'
                    })
                }
            };
        }
        
        // Create mock target for testing
        function createMockTarget() {
            return {
                position: { x: 10, y: 0, z: 0 }, // 10 units away
                name: 'Test Planet'
            };
        }
        
        // Update ship status display
        function updateShipStatus() {
            if (!ship) return;
            
            const status = ship.getStatus();
            const html = `
                <strong>Ship Type:</strong> ${status.shipType}<br>
                <strong>Hull:</strong> ${status.hull.current.toFixed(0)}/${status.hull.max} (${status.hull.percentage.toFixed(1)}%)<br>
                <strong>Energy:</strong> ${status.energy.current.toFixed(0)}/${status.energy.max} (${status.energy.percentage.toFixed(1)}%)<br>
                <strong>Speed:</strong> Impulse ${mockStarfieldManager?.currentSpeed || 1}<br>
                <strong>Systems:</strong> ${status.systemCount} installed<br>
                <br>
                <strong>System Status:</strong><br>
                ${Object.entries(status.systems).map(([name, sys]) => 
                    `‚Ä¢ ${formatSystemName(name)}: ${(sys.health * 100).toFixed(1)}% ${sys.isActive ? '(Active)' : '(Inactive)'}`
                ).join('<br>')}
            `;
            
            document.getElementById('shipStatus').innerHTML = html;
        }
        
        // Update docking requirements display
        function updateDockingRequirements() {
            if (!dockingSystemManager) return;
            
            const requirements = dockingSystemManager.getDockingRequirements();
            const html = `
                <strong>Minimum Energy:</strong> ${requirements.minimumEnergy}<br>
                <strong>Minimum Hull Integrity:</strong> ${requirements.minimumHullIntegrity}%<br>
                <strong>Maximum Docking Speed:</strong> Impulse ${requirements.maximumDockingSpeed}<br>
                <strong>Docking Energy Cost:</strong> ${requirements.dockingEnergyCost}<br>
                <strong>Launch Energy Cost:</strong> ${requirements.launchEnergyCost}<br>
                <strong>Docking Range:</strong> ${requirements.dockingRange} km
            `;
            
            document.getElementById('dockingRequirements').innerHTML = html;
        }
        
        // Test functions
        window.setShipEnergy = function(percentage) {
            if (!ship) return;
            ship.currentEnergy = (ship.maxEnergy * percentage) / 100;
            updateShipStatus();
            appendToConsole(`‚ö° Ship energy set to ${percentage}%`, 'info');
        };
        
        window.damageHull = function(percentage) {
            if (!ship) return;
            ship.currentHull = ship.maxHull * (1 - percentage / 100);
            updateShipStatus();
            appendToConsole(`üí• Hull damaged to ${((ship.currentHull / ship.maxHull) * 100).toFixed(1)}%`, 'warn');
        };
        
        window.repairShip = function() {
            if (!ship) return;
            ship.currentHull = ship.maxHull;
            ship.currentEnergy = ship.maxEnergy;
            
            // Repair all systems
            for (const [name, system] of ship.systems) {
                system.repair(1.0); // Full repair
            }
            
            updateShipStatus();
            appendToConsole('üîß Ship fully repaired', 'success');
        };
        
        window.damageSystem = function(systemName) {
            if (!ship) return;
            const system = ship.getSystem(systemName);
            if (system) {
                system.takeDamage(0.8); // 80% damage
                updateShipStatus();
                appendToConsole(`‚ö†Ô∏è ${formatSystemName(systemName)} damaged`, 'warn');
            }
        };
        
        window.repairSystem = function(systemName) {
            if (!ship) return;
            const system = ship.getSystem(systemName);
            if (system) {
                system.repair(1.0); // Full repair
                updateShipStatus();
                appendToConsole(`üîß ${formatSystemName(systemName)} repaired`, 'success');
            }
        };
        
        window.setSpeed = function(impulseSpeed) {
            if (!mockStarfieldManager) return;
            mockStarfieldManager.currentSpeed = impulseSpeed;
            updateShipStatus();
            appendToConsole(`üöÄ Speed set to Impulse ${impulseSpeed}`, 'info');
        };
        
        window.testDockingValidation = function() {
            if (!dockingSystemManager || !ship || !mockStarfieldManager || !mockTarget) {
                appendToConsole('‚ùå Systems not initialized', 'error');
                return;
            }
            
            const validation = dockingSystemManager.validateDocking(ship, mockTarget, mockStarfieldManager);
            
            let html = '';
            
            if (validation.canDock) {
                html += '<div class="validation-success">‚úÖ <strong>DOCKING APPROVED</strong></div>';
                appendToConsole('‚úÖ Docking validation passed', 'success');
            } else {
                html += '<div class="validation-failure">‚ùå <strong>DOCKING DENIED</strong></div>';
                appendToConsole('‚ùå Docking validation failed', 'error');
            }
            
            if (validation.reasons.length > 0) {
                html += '<div class="validation-failure"><strong>Reasons:</strong><br>';
                validation.reasons.forEach(reason => {
                    html += `‚Ä¢ ${reason}<br>`;
                    appendToConsole(`  - ${reason}`, 'error');
                });
                html += '</div>';
            }
            
            if (validation.warnings.length > 0) {
                html += '<div class="validation-warning"><strong>Warnings:</strong><br>';
                validation.warnings.forEach(warning => {
                    html += `‚Ä¢ ${warning}<br>`;
                    appendToConsole(`  ‚ö†Ô∏è ${warning}`, 'warn');
                });
                html += '</div>';
            }
            
            html += `<div><strong>Energy Cost:</strong> ${validation.energyCost}</div>`;
            
            document.getElementById('validationResults').innerHTML = html;
        };
        
        window.testLaunchValidation = function() {
            if (!dockingSystemManager || !ship) {
                appendToConsole('‚ùå Systems not initialized', 'error');
                return;
            }
            
            const validation = dockingSystemManager.validateLaunch(ship);
            
            let html = '';
            
            if (validation.canLaunch) {
                html += '<div class="validation-success">‚úÖ <strong>LAUNCH APPROVED</strong></div>';
                appendToConsole('‚úÖ Launch validation passed', 'success');
            } else {
                html += '<div class="validation-failure">‚ùå <strong>LAUNCH DENIED</strong></div>';
                appendToConsole('‚ùå Launch validation failed', 'error');
            }
            
            if (validation.reasons.length > 0) {
                html += '<div class="validation-failure"><strong>Reasons:</strong><br>';
                validation.reasons.forEach(reason => {
                    html += `‚Ä¢ ${reason}<br>`;
                    appendToConsole(`  - ${reason}`, 'error');
                });
                html += '</div>';
            }
            
            if (validation.warnings.length > 0) {
                html += '<div class="validation-warning"><strong>Warnings:</strong><br>';
                validation.warnings.forEach(warning => {
                    html += `‚Ä¢ ${warning}<br>`;
                    appendToConsole(`  ‚ö†Ô∏è ${warning}`, 'warn');
                });
                html += '</div>';
            }
            
            html += `<div><strong>Energy Cost:</strong> ${validation.energyCost}</div>`;
            
            document.getElementById('validationResults').innerHTML = html;
        };
        
        window.simulateDocking = function() {
            if (!mockStarfieldManager) return;
            
            if (mockStarfieldManager.isDocked) {
                appendToConsole('‚ùå Already docked', 'error');
                return;
            }
            
            const validation = dockingSystemManager.validateDocking(ship, mockTarget, mockStarfieldManager);
            
            if (validation.canDock) {
                mockStarfieldManager.isDocked = true;
                ship.consumeEnergy(validation.energyCost);
                updateShipStatus();
                appendToConsole('üö¢ Docking simulation successful', 'success');
            } else {
                appendToConsole('‚ùå Cannot dock: ' + validation.reasons.join(', '), 'error');
            }
        };
        
        window.simulateUndocking = function() {
            if (!mockStarfieldManager) return;
            
            if (!mockStarfieldManager.isDocked) {
                appendToConsole('‚ùå Not currently docked', 'error');
                return;
            }
            
            const validation = dockingSystemManager.validateLaunch(ship);
            
            if (validation.canLaunch) {
                mockStarfieldManager.isDocked = false;
                ship.consumeEnergy(validation.energyCost);
                updateShipStatus();
                appendToConsole('üöÄ Launch simulation successful', 'success');
            } else {
                appendToConsole('‚ùå Cannot launch: ' + validation.reasons.join(', '), 'error');
            }
        };
        
        // Utility functions
        function formatSystemName(systemName) {
            return systemName
                .replace(/_/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase());
        }
        
        function appendToConsole(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            
            const icon = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'warn': '‚ö†Ô∏è',
                'error': '‚ùå'
            }[type] || '‚ÑπÔ∏è';
            
            logEntry.innerHTML = `[${timestamp}] ${icon} ${message}`;
            
            const output = document.getElementById('consoleOutput');
            output.appendChild(logEntry);
            output.scrollTop = output.scrollHeight;
        }
        
        // Initialize when page loads
        initializeSystems();
        
        // Update ship status every 2 seconds
        setInterval(() => {
            if (ship) {
                ship.update(2000); // 2 second delta
                updateShipStatus();
            }
        }, 2000);
    </script>
</body>
</html> 