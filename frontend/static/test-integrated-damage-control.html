<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated Damage Control Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #000;
            color: #00ff41;
            font-family: "Courier New", monospace;
            overflow: hidden;
        }
        
        .test-controls {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 2000;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ff41;
            padding: 10px;
            font-size: 12px;
        }
        
        .test-button {
            background: #00aa41;
            color: #000;
            border: none;
            padding: 5px 10px;
            margin: 2px;
            cursor: pointer;
            font-family: "Courier New", monospace;
            font-size: 11px;
        }
        
        .test-button:hover {
            background: #00ff41;
        }
        
        .instructions {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 2000;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ff41;
            padding: 10px;
            font-size: 11px;
            max-width: 300px;
        }
        
        #canvas {
            display: block;
        }
    </style>
</head>
<body>
    <div class="test-controls">
        <div><strong>üõ†Ô∏è Damage Control Test</strong></div>
        <button class="test-button" onclick="damageRandomSystem()">Damage Random System</button>
        <button class="test-button" onclick="damageAllSystems()">Damage All Systems</button>
        <button class="test-button" onclick="repairAllSystems()">Repair All Systems</button>
        <button class="test-button" onclick="toggleAutoRepair()">Toggle Auto-Repair</button>
    </div>
    
    <div class="instructions">
        <strong>üìã Instructions:</strong><br>
        ‚Ä¢ Press <strong>'D'</strong> to toggle damage control view<br>
        ‚Ä¢ Press <strong>'F'</strong> to return to ship systems view<br>
        ‚Ä¢ In damage control view, adjust priority sliders<br>
        ‚Ä¢ Use test buttons to damage/repair systems<br>
        ‚Ä¢ Watch auto-repair system work in real-time
    </div>

    <canvas id="canvas"></canvas>

    <!-- Load Three.js first -->
    <script src="./lib/three.min.js"></script>
    
    <script type="module">
        import Ship from './js/ship/Ship.js';
        import { StarfieldManager } from './js/views/StarfieldManager.js';

        let scene, camera, renderer;
        let ship, starfieldManager;
        let mockViewManager;

        // Mock ViewManager for testing
        class MockViewManager {
            constructor() {
                this.frontCrosshair = { style: { display: 'none' } };
                this.aftCrosshair = { style: { display: 'none' } };
                this.currentView = 'FORE';
            }
            
            getShip() {
                return ship;
            }
            
            playCommandSound() {
                // Mock sound
            }
        }

        async function init() {
            // Create Three.js scene
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 10000);
            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas') });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000);

            // Create ship
            ship = new Ship('heavy_fighter');
            await ship.waitForSystemsInitialized();

            // Create mock view manager
            mockViewManager = new MockViewManager();

            // Create StarfieldManager
            starfieldManager = new StarfieldManager(scene, camera, mockViewManager);
            starfieldManager.ship = ship;

            // Start auto-repair system
            if (ship.autoRepairSystem) {
                ship.autoRepairSystem.start();
            }

            // Start render loop
            animate();

            console.log('Integrated damage control test initialized');
            console.log('Press D to toggle damage control view');
        }

        function animate() {
            requestAnimationFrame(animate);
            
            // Update ship and starfield manager
            if (ship) {
                ship.update(16); // ~60fps
            }
            if (starfieldManager) {
                starfieldManager.update(16);
            }
            
            renderer.render(scene, camera);
        }

        // Test functions
        window.damageRandomSystem = function() {
            if (!ship) return;
            
            const systemNames = Array.from(ship.systems.keys());
            const randomSystem = systemNames[Math.floor(Math.random() * systemNames.length)];
            const system = ship.systems.get(randomSystem);
            
            // Apply 40-80% damage
            const damage = 0.4 + Math.random() * 0.4;
            system.takeDamage(damage);
            
            console.log(`Damaged ${randomSystem} by ${(damage * 100).toFixed(1)}%`);
        };

        window.damageAllSystems = function() {
            if (!ship) return;
            
            for (const [systemName, system] of ship.systems) {
                const damage = 0.3 + Math.random() * 0.5; // 30-80% damage
                system.takeDamage(damage);
            }
            
            console.log('All systems damaged');
        };

        window.repairAllSystems = function() {
            if (!ship) return;
            
            for (const [systemName, system] of ship.systems) {
                system.repair(1.0); // Full repair
            }
            
            console.log('All systems repaired to 100%');
        };

        window.toggleAutoRepair = function() {
            if (!ship || !ship.autoRepairSystem) return;
            
            if (ship.autoRepairSystem.isActive) {
                ship.autoRepairSystem.stop();
                console.log('Auto-repair system stopped');
            } else {
                ship.autoRepairSystem.start();
                console.log('Auto-repair system started');
            }
        };

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Initialize the test
        init().catch(error => {
            console.error('Failed to initialize test:', error);
        });
    </script>
</body>
</html> 