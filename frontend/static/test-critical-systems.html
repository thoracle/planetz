<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Critical Systems Protection Test</title>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #00ff41;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            border-bottom: 2px solid #00ff41;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .test-section {
            border: 1px solid #00ff41;
            margin: 20px 0;
            padding: 20px;
            background: rgba(0, 255, 65, 0.05);
        }
        .critical-system {
            border: 2px solid #ff6600;
            background: rgba(255, 102, 0, 0.1);
            padding: 15px;
            margin: 20px 0;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .status-box {
            border: 1px solid #00aa41;
            padding: 15px;
            background: rgba(0, 170, 65, 0.1);
        }
        .controls {
            text-align: center;
            margin: 30px 0;
        }
        .btn {
            background: #00aa41;
            color: #000;
            border: none;
            padding: 12px 24px;
            margin: 0 10px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .btn:hover {
            background: #00cc51;
            transform: scale(1.05);
        }
        .btn-danger {
            background: #aa4100;
            color: #fff;
        }
        .btn-danger:hover {
            background: #cc4f00;
        }
        .btn-warning {
            background: #ffaa00;
            color: #000;
        }
        .btn-warning:hover {
            background: #ffcc33;
        }
        .log {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00ff41;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-size: 12px;
            margin-top: 20px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-info { color: #00ff41; }
        .log-warning { color: #ffaa00; }
        .log-error { color: #ff4444; }
        .log-success { color: #44ff44; }
        .protection-indicator {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid;
        }
        .protected {
            border-color: #00ff41;
            background: rgba(0, 255, 65, 0.2);
            color: #00ff41;
        }
        .vulnerable {
            border-color: #ff4444;
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è CRITICAL SYSTEMS PROTECTION TEST üõ°Ô∏è</h1>
            <p>Testing that Impulse Engines and Warp Drive can never be completely disabled</p>
            <p><strong>Requirement:</strong> These systems must always maintain emergency capability for reaching starbases</p>
        </div>

        <div class="test-section">
            <h2>Critical Systems Status</h2>
            <div class="status-grid">
                <div class="critical-system">
                    <h3>üöÄ Impulse Engines</h3>
                    <div id="impulseStatus">Loading...</div>
                    <div class="protection-indicator" id="impulseProtection">CHECKING...</div>
                </div>
                <div class="critical-system">
                    <h3>‚ö° Warp Drive</h3>
                    <div id="warpStatus">Loading...</div>
                    <div class="protection-indicator" id="warpProtection">CHECKING...</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>Damage Testing Controls</h2>
            <div class="controls">
                <button class="btn btn-danger" onclick="massiveDamageImpulse()">Massive Damage to Impulse</button>
                <button class="btn btn-danger" onclick="massiveDamageWarp()">Massive Damage to Warp</button>
                <button class="btn btn-danger" onclick="massiveDamageBoth()">Massive Damage to Both</button>
                <button class="btn btn-warning" onclick="extremeDamageTest()">EXTREME Damage Test</button>
                <button class="btn" onclick="repairBothSystems()">Repair Both Systems</button>
                <button class="btn" onclick="refreshDisplay()">Refresh Display</button>
            </div>
        </div>

        <div class="test-section">
            <h2>Emergency Capability Test</h2>
            <div class="controls">
                <button class="btn" onclick="testEmergencyMovement()">Test Emergency Movement</button>
                <button class="btn" onclick="testEmergencyWarp()">Test Emergency Warp</button>
                <button class="btn" onclick="testRepairability()">Test Repair Kit Compatibility</button>
            </div>
            <div class="status-grid">
                <div class="status-box">
                    <h3>Emergency Movement</h3>
                    <div id="emergencyMovement">Not Tested</div>
                </div>
                <div class="status-box">
                    <h3>Emergency Warp</h3>
                    <div id="emergencyWarp">Not Tested</div>
                </div>
                <div class="status-box">
                    <h3>Repair Kit Compatibility</h3>
                    <div id="repairCompatibility">Not Tested</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>All Ship Systems</h2>
            <div class="system-list" id="systemsList">
                Loading systems...
            </div>
        </div>

        <div class="test-section">
            <h2>Test Log</h2>
            <div class="log" id="testLog"></div>
        </div>
    </div>

    <script type="module">
        import Ship from './js/ship/Ship.js';
        
        let ship = null;
        let impulseEngines = null;
        let warpDrive = null;
        
        // Initialize ship
        async function initializeShip() {
            try {
                ship = new Ship('heavy_fighter');
                
                // Wait for systems to initialize
                await new Promise(resolve => setTimeout(resolve, 500));
                
                impulseEngines = ship.getSystem('impulse_engines');
                warpDrive = ship.getSystem('warp_drive');
                
                if (!impulseEngines || !warpDrive) {
                    throw new Error('Critical systems not found');
                }
                
                log('Ship initialized successfully', 'success');
                log(`Impulse Engines: ${impulseEngines.name} (Level ${impulseEngines.level})`, 'info');
                log(`Warp Drive: ${warpDrive.name} (Level ${warpDrive.level})`, 'info');
                
                refreshDisplay();
                
            } catch (error) {
                log(`Error initializing ship: ${error.message}`, 'error');
            }
        }
        
        // Apply massive damage to impulse engines
        window.massiveDamageImpulse = function() {
            if (!impulseEngines) return;
            
            log('=== MASSIVE DAMAGE TEST: IMPULSE ENGINES ===', 'warning');
            const damage = impulseEngines.maxHealth * 0.95; // 95% damage
            log(`Applying ${damage.toFixed(1)} damage to impulse engines (95% of max health)`, 'warning');
            
            impulseEngines.takeDamage(damage);
            
            log(`Post-damage health: ${(impulseEngines.healthPercentage * 100).toFixed(1)}%`, 'info');
            log(`System operational: ${impulseEngines.isOperational()}`, 'info');
            log(`Max impulse speed: ${impulseEngines.getMaxImpulseSpeed()}`, 'info');
            
            refreshDisplay();
        };
        
        // Apply massive damage to warp drive
        window.massiveDamageWarp = function() {
            if (!warpDrive) return;
            
            log('=== MASSIVE DAMAGE TEST: WARP DRIVE ===', 'warning');
            const damage = warpDrive.maxHealth * 0.95; // 95% damage
            log(`Applying ${damage.toFixed(1)} damage to warp drive (95% of max health)`, 'warning');
            
            warpDrive.takeDamage(damage);
            
            log(`Post-damage health: ${(warpDrive.healthPercentage * 100).toFixed(1)}%`, 'info');
            log(`System operational: ${warpDrive.isOperational()}`, 'info');
            log(`Max warp factor: ${warpDrive.getMaxWarpFactor()}`, 'info');
            
            refreshDisplay();
        };
        
        // Apply massive damage to both systems
        window.massiveDamageBoth = function() {
            log('=== MASSIVE DAMAGE TEST: BOTH CRITICAL SYSTEMS ===', 'warning');
            massiveDamageImpulse();
            massiveDamageWarp();
        };
        
        // Extreme damage test - try to completely destroy systems
        window.extremeDamageTest = function() {
            if (!impulseEngines || !warpDrive) return;
            
            log('=== EXTREME DAMAGE TEST: ATTEMPTING COMPLETE DESTRUCTION ===', 'error');
            
            // Try to apply 200% damage to both systems
            const extremeDamage = Math.max(impulseEngines.maxHealth, warpDrive.maxHealth) * 2;
            
            log(`Attempting to apply ${extremeDamage.toFixed(1)} damage to both systems (200% of max health)`, 'error');
            
            impulseEngines.takeDamage(extremeDamage);
            warpDrive.takeDamage(extremeDamage);
            
            log(`Impulse health after extreme damage: ${(impulseEngines.healthPercentage * 100).toFixed(1)}%`, 'info');
            log(`Warp health after extreme damage: ${(warpDrive.healthPercentage * 100).toFixed(1)}%`, 'info');
            log(`Impulse operational: ${impulseEngines.isOperational()}`, 'info');
            log(`Warp operational: ${warpDrive.isOperational()}`, 'info');
            
            refreshDisplay();
        };
        
        // Repair both systems
        window.repairBothSystems = function() {
            if (!impulseEngines || !warpDrive) return;
            
            log('=== REPAIRING BOTH CRITICAL SYSTEMS ===', 'success');
            
            impulseEngines.repair(1.0); // Full repair
            warpDrive.repair(1.0); // Full repair
            
            log('Both systems fully repaired', 'success');
            refreshDisplay();
        };
        
        // Test emergency movement capability
        window.testEmergencyMovement = function() {
            if (!impulseEngines) return;
            
            log('=== TESTING EMERGENCY MOVEMENT CAPABILITY ===', 'info');
            
            const maxSpeed = impulseEngines.getMaxImpulseSpeed();
            const canMove = impulseEngines.setImpulseSpeed(1);
            const actualSpeed = impulseEngines.getImpulseSpeed();
            
            const result = canMove && actualSpeed >= 1 ? 'PASS' : 'FAIL';
            const resultElement = document.getElementById('emergencyMovement');
            
            if (result === 'PASS') {
                resultElement.innerHTML = `‚úÖ PASS - Can achieve Impulse ${actualSpeed} (Max: ${maxSpeed})`;
                resultElement.style.color = '#00ff41';
                log(`Emergency movement test PASSED - Impulse ${actualSpeed} available`, 'success');
            } else {
                resultElement.innerHTML = `‚ùå FAIL - Cannot achieve emergency movement`;
                resultElement.style.color = '#ff4444';
                log(`Emergency movement test FAILED`, 'error');
            }
        };
        
        // Test emergency warp capability
        window.testEmergencyWarp = function() {
            if (!warpDrive) return;
            
            log('=== TESTING EMERGENCY WARP CAPABILITY ===', 'info');
            
            const maxTravelDistance = warpDrive.getMaxTravelDistance();
            const isOperational = warpDrive.isOperational();
            
            const result = isOperational && maxTravelDistance >= 1 ? 'PASS' : 'FAIL';
            const resultElement = document.getElementById('emergencyWarp');
            
            if (result === 'PASS') {
                resultElement.innerHTML = `‚úÖ PASS - Can travel ${maxTravelDistance} sector${maxTravelDistance > 1 ? 's' : ''} per jump`;
                resultElement.style.color = '#00ff41';
                log(`Emergency warp test PASSED - ${maxTravelDistance} sector travel range available`, 'success');
            } else {
                resultElement.innerHTML = `‚ùå FAIL - Cannot achieve emergency warp`;
                resultElement.style.color = '#ff4444';
                log(`Emergency warp test FAILED`, 'error');
            }
        };
        
        // Test repair kit compatibility
        window.testRepairability = function() {
            if (!impulseEngines || !warpDrive) return;
            
            log('=== TESTING REPAIR KIT COMPATIBILITY ===', 'info');
            
            // Damage both systems first
            impulseEngines.takeDamage(50);
            warpDrive.takeDamage(50);
            
            const impulseHealthBefore = impulseEngines.healthPercentage;
            const warpHealthBefore = warpDrive.healthPercentage;
            
            // Simulate repair kit usage (25% repair)
            impulseEngines.repair(0.25);
            warpDrive.repair(0.25);
            
            const impulseHealthAfter = impulseEngines.healthPercentage;
            const warpHealthAfter = warpDrive.healthPercentage;
            
            const impulseRepaired = impulseHealthAfter > impulseHealthBefore;
            const warpRepaired = warpHealthAfter > warpHealthBefore;
            
            const result = impulseRepaired && warpRepaired ? 'PASS' : 'FAIL';
            const resultElement = document.getElementById('repairCompatibility');
            
            if (result === 'PASS') {
                resultElement.innerHTML = `‚úÖ PASS - Both systems can be repaired with kits`;
                resultElement.style.color = '#00ff41';
                log(`Repair kit test PASSED - Both systems repairable`, 'success');
            } else {
                resultElement.innerHTML = `‚ùå FAIL - Systems cannot be repaired`;
                resultElement.style.color = '#ff4444';
                log(`Repair kit test FAILED`, 'error');
            }
        };
        
        // Refresh display
        window.refreshDisplay = function() {
            if (!ship || !impulseEngines || !warpDrive) return;
            
            updateCriticalSystemsStatus();
            updateSystemsList();
        };
        
        function updateCriticalSystemsStatus() {
            // Update impulse engines status
            const impulseStatus = document.getElementById('impulseStatus');
            const impulseProtection = document.getElementById('impulseProtection');
            
            const impulseHealth = (impulseEngines.healthPercentage * 100).toFixed(1);
            const impulseMaxSpeed = impulseEngines.getMaxImpulseSpeed();
            const impulseOperational = impulseEngines.isOperational();
            
            impulseStatus.innerHTML = `
                <div>Health: ${impulseHealth}%</div>
                <div>Operational: ${impulseOperational ? 'YES' : 'NO'}</div>
                <div>Max Speed: Impulse ${impulseMaxSpeed}</div>
                <div>State: ${impulseEngines.state}</div>
            `;
            
            // Check protection status
            const impulseProtected = impulseOperational && impulseMaxSpeed >= 1;
            impulseProtection.textContent = impulseProtected ? 'üõ°Ô∏è PROTECTED' : '‚ö†Ô∏è VULNERABLE';
            impulseProtection.className = `protection-indicator ${impulseProtected ? 'protected' : 'vulnerable'}`;
            
            // Update warp drive status
            const warpStatus = document.getElementById('warpStatus');
            const warpProtection = document.getElementById('warpProtection');
            
            const warpHealth = (warpDrive.healthPercentage * 100).toFixed(1);
            const warpMaxDistance = warpDrive.getMaxTravelDistance();
            const warpOperational = warpDrive.isOperational();
            
            warpStatus.innerHTML = `
                <div>Health: ${warpHealth}%</div>
                <div>Operational: ${warpOperational ? 'YES' : 'NO'}</div>
                <div>Max Range: ${warpMaxDistance} sector${warpMaxDistance > 1 ? 's' : ''}</div>
                <div>State: ${warpDrive.state}</div>
            `;
            
            // Check protection status
            const warpProtected = warpOperational && warpMaxDistance >= 1;
            warpProtection.textContent = warpProtected ? 'üõ°Ô∏è PROTECTED' : '‚ö†Ô∏è VULNERABLE';
            warpProtection.className = `protection-indicator ${warpProtected ? 'protected' : 'vulnerable'}`;
        }
        
        function updateSystemsList() {
            const systemsList = document.getElementById('systemsList');
            systemsList.innerHTML = '';
            
            for (const [systemName, system] of ship.systems) {
                const systemItem = document.createElement('div');
                systemItem.style.cssText = `
                    display: flex;
                    justify-content: space-between;
                    padding: 8px;
                    margin: 5px 0;
                    border: 1px solid ${system.isOperational() ? '#00aa41' : '#aa4100'};
                    background: ${system.isOperational() ? 'rgba(0, 170, 65, 0.1)' : 'rgba(170, 65, 0, 0.1)'};
                `;
                
                const health = Math.round(system.healthPercentage * 100);
                const isCritical = systemName === 'impulse_engines' || systemName === 'warp_drive';
                const criticalIndicator = isCritical ? ' üõ°Ô∏è' : '';
                
                systemItem.innerHTML = `
                    <span>${formatSystemName(systemName)}${criticalIndicator}</span>
                    <span>${health}% | ${system.isOperational() ? 'OPERATIONAL' : 'DAMAGED'}</span>
                `;
                
                systemsList.appendChild(systemItem);
            }
        }
        
        function formatSystemName(systemName) {
            const nameMap = {
                'shields': 'SHIELDS',
                'impulse_engines': 'IMPULSE ENGINES',
                'warp_drive': 'WARP DRIVE',
                'weapons': 'WEAPONS',
                'long_range_scanner': 'LR SCANNER',
                'target_computer': 'TARGET COMPUTER',
                'subspace_radio': 'SUBSPACE RADIO'
            };
            return nameMap[systemName] || systemName.toUpperCase();
        }
        
        function log(message, type = 'info') {
            const logElement = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
            
            // Also log to console
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // Auto-refresh display every 2 seconds
        setInterval(() => {
            if (ship) {
                ship.update(1000); // Update ship systems
                refreshDisplay();
            }
        }, 2000);
        
        // Initialize when page loads
        window.addEventListener('load', initializeShip);
        
        // Make functions globally available
        window.log = log;
    </script>
</body>
</html> 