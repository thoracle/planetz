<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Damage Control Interface Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #00ff41;
            margin: 0;
            padding: 20px;
            line-height: 1.4;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            border: 2px solid #00ff41;
            padding: 20px;
            margin-bottom: 20px;
            background: rgba(0, 20, 0, 0.3);
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        button {
            background: rgba(0, 20, 0, 0.5);
            border: 1px solid #00ff41;
            color: #00ff41;
            padding: 10px 15px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s ease;
        }
        
        button:hover {
            background: rgba(0, 255, 65, 0.1);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
        }
        
        .instructions {
            background: rgba(0, 20, 0, 0.3);
            border: 1px solid #00ff41;
            padding: 15px;
            margin: 20px 0;
            font-size: 14px;
        }
        
        .instructions h3 {
            color: #00ff41;
            margin: 0 0 10px 0;
        }
        
        .instructions ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .instructions li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß SIMPLE DAMAGE CONTROL TEST üîß</h1>
            <p>Testing the integrated damage control interface in Ship Systems HUD</p>
        </div>

        <div class="controls">
            <button onclick="damageRandomSystem()">üí• Damage Random System</button>
            <button onclick="damageAllSystems()">üíÄ Damage All Systems</button>
            <button onclick="repairAllSystems()">üîß Repair All Systems</button>
            <button onclick="toggleAutoRepair()">‚ö° Toggle Auto-Repair</button>
        </div>

        <div class="instructions">
            <h3>Instructions:</h3>
            <ul>
                <li><strong>Press 'D' key:</strong> Switch to damage control view in Ship Systems HUD</li>
                <li><strong>Damage Systems:</strong> Use buttons above to damage systems for testing</li>
                <li><strong>Priority Sliders:</strong> Drag sliders to set repair priorities (0-10)</li>
                <li><strong>Zero-Sum System:</strong> Total priority points limited to 100</li>
                <li><strong>Status Dots:</strong> Green = active, Gray = inactive</li>
                <li><strong>Auto-Repair:</strong> Watch systems slowly repair based on priority</li>
            </ul>
            
            <h3>Key Features:</h3>
            <ul>
                <li>üéØ <strong>Integrated View:</strong> Part of Ship Systems HUD (press D)</li>
                <li>üîß <strong>Priority Sliders:</strong> Set repair priorities for each system</li>
                <li>‚öñÔ∏è <strong>Zero-Sum:</strong> 100 total priority points to distribute</li>
                <li>üîÑ <strong>Auto-Repair:</strong> Systems repair based on priority queue</li>
                <li>üìä <strong>Status Indicators:</strong> Dots show system active/inactive state</li>
            </ul>
        </div>
    </div>

    <script type="module">
        import Ship from './js/ship/Ship.js';

        let ship = null;
        let starfieldManager = null;

        // Mock ViewManager for testing
        class MockViewManager {
            constructor() {
                this.frontCrosshair = { style: { display: 'none' } };
                this.aftCrosshair = { style: { display: 'none' } };
            }
            
            getShip() {
                return ship;
            }
        }

        // Mock StarfieldManager for testing
        class MockStarfieldManager {
            constructor() {
                this.view = 'FORE';
                this.isDocked = false;
                this.ship = null;
                this.viewManager = new MockViewManager();
                this.systemsList = null;
                this.shipSystemsHUD = null;
                
                this.createShipSystemsHUD();
                this.bindKeyEvents();
            }

            createShipSystemsHUD() {
                // Create ship systems status container
                this.shipSystemsHUD = document.createElement('div');
                this.shipSystemsHUD.style.cssText = `
                    position: fixed;
                    top: 60px;
                    left: 10px;
                    color: #00ff41;
                    font-family: "Courier New", monospace;
                    font-size: 14px;
                    pointer-events: none;
                    z-index: 1000;
                    border: 1px solid #00ff41;
                    padding: 8px 12px;
                    background: rgba(0, 0, 0, 0.7);
                    min-width: 200px;
                `;

                // Create systems list container
                this.systemsList = document.createElement('div');
                this.systemsList.style.cssText = `
                    display: flex;
                    flex-direction: column;
                    gap: 4px;
                `;

                this.shipSystemsHUD.appendChild(this.systemsList);
                document.body.appendChild(this.shipSystemsHUD);

                // Update the systems display
                this.updateShipSystemsDisplay();
            }

            updateShipSystemsDisplay() {
                if (!this.ship || !this.systemsList) {
                    return;
                }

                // Clear existing system displays
                this.systemsList.innerHTML = '';

                // Get ship status
                const shipStatus = this.ship.getStatus();
                
                // Check if we're in damage control view
                if (this.view === 'DAMAGE') {
                    this.updateDamageControlDisplay(shipStatus);
                    return;
                }
                
                // Create header
                const header = document.createElement('div');
                header.style.cssText = `
                    font-weight: bold;
                    margin-bottom: 4px;
                    border-bottom: 1px solid #00ff41;
                    padding-bottom: 2px;
                `;
                header.textContent = 'SHIP SYSTEMS';
                this.systemsList.appendChild(header);

                // Add view indicator
                const viewDiv = document.createElement('div');
                viewDiv.style.cssText = `font-size: 12px; color: #00aa41; margin-bottom: 4px;`;
                viewDiv.textContent = `View: ${this.view}`;
                this.systemsList.appendChild(viewDiv);

                // Add energy consumption rate
                const energyRate = this.ship.getEnergyConsumptionRate();
                const energyDisplay = document.createElement('div');
                energyDisplay.style.cssText = `font-size: 12px; color: #00aa41;`;
                energyDisplay.textContent = `Energy Usage: ${energyRate.toFixed(1)}/s`;
                this.systemsList.appendChild(energyDisplay);

                // Display each system
                for (const [systemName, systemInfo] of Object.entries(shipStatus.systems)) {
                    const systemElement = document.createElement('div');
                    systemElement.style.cssText = `
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        font-size: 12px;
                    `;

                    // Status indicator dot
                    const statusDot = document.createElement('span');
                    statusDot.style.cssText = `
                        width: 8px;
                        height: 8px;
                        border-radius: 50%;
                        display: inline-block;
                        margin-right: 6px;
                        background-color: ${systemInfo.isActive ? '#00ff41' : '#666666'};
                    `;

                    // System name with dot
                    const nameSpan = document.createElement('span');
                    nameSpan.style.cssText = `display: flex; align-items: center;`;
                    nameSpan.appendChild(statusDot);
                    nameSpan.appendChild(document.createTextNode(this.formatSystemName(systemName)));
                    
                    // System status (health only)
                    const statusSpan = document.createElement('span');
                    const health = Math.round(systemInfo.health * 100);
                    
                    // Color code based on health
                    let color = '#00ff41'; // Green for healthy
                    if (health < 75) color = '#ffaa00'; // Orange for damaged
                    if (health < 25) color = '#ff4400'; // Red for critical
                    
                    statusSpan.style.color = color;
                    statusSpan.textContent = `${health}%`;
                    
                    systemElement.appendChild(nameSpan);
                    systemElement.appendChild(statusSpan);
                    this.systemsList.appendChild(systemElement);
                }
            }

            updateDamageControlDisplay(shipStatus) {
                // Create header
                const header = document.createElement('div');
                header.style.cssText = `
                    font-weight: bold;
                    margin-bottom: 8px;
                    border-bottom: 1px solid #00ff41;
                    padding-bottom: 2px;
                `;
                header.textContent = 'DAMAGE CONTROL';
                this.systemsList.appendChild(header);

                // Add view indicator
                const viewDiv = document.createElement('div');
                viewDiv.style.cssText = `font-size: 12px; color: #00aa41; margin-bottom: 8px;`;
                viewDiv.textContent = `View: ${this.view}`;
                this.systemsList.appendChild(viewDiv);

                // Get auto-repair system
                const autoRepair = this.ship.autoRepairSystem;
                if (!autoRepair) {
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = `color: #ff4400; font-size: 12px;`;
                    errorDiv.textContent = 'Auto-repair system not available';
                    this.systemsList.appendChild(errorDiv);
                    return;
                }

                // Current repair status
                const statusDiv = document.createElement('div');
                statusDiv.style.cssText = `font-size: 12px; color: #00aa41; margin-bottom: 8px;`;
                const currentTarget = autoRepair.getCurrentRepairTarget();
                statusDiv.textContent = currentTarget ? 
                    `Repairing: ${this.formatSystemName(currentTarget)}` : 
                    'Auto-repair: Standby';
                this.systemsList.appendChild(statusDiv);

                // Priority sliders for each system
                for (const [systemName, systemInfo] of Object.entries(shipStatus.systems)) {
                    const systemDiv = document.createElement('div');
                    systemDiv.style.cssText = `
                        margin-bottom: 6px;
                        font-size: 11px;
                    `;

                    // System name with status dot and health
                    const nameDiv = document.createElement('div');
                    nameDiv.style.cssText = `
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 2px;
                    `;

                    const nameWithDot = document.createElement('span');
                    nameWithDot.style.cssText = `display: flex; align-items: center;`;
                    
                    const statusDot = document.createElement('span');
                    statusDot.style.cssText = `
                        width: 6px;
                        height: 6px;
                        border-radius: 50%;
                        display: inline-block;
                        margin-right: 4px;
                        background-color: ${systemInfo.isActive ? '#00ff41' : '#666666'};
                    `;
                    
                    nameWithDot.appendChild(statusDot);
                    nameWithDot.appendChild(document.createTextNode(this.formatSystemName(systemName)));

                    const healthSpan = document.createElement('span');
                    const health = Math.round(systemInfo.health * 100);
                    let color = '#00ff41';
                    if (health < 75) color = '#ffaa00';
                    if (health < 25) color = '#ff4400';
                    healthSpan.style.color = color;
                    healthSpan.textContent = `${health}%`;

                    nameDiv.appendChild(nameWithDot);
                    nameDiv.appendChild(healthSpan);

                    // Priority slider
                    const sliderDiv = document.createElement('div');
                    sliderDiv.style.cssText = `
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    `;

                    const slider = document.createElement('input');
                    slider.type = 'range';
                    slider.min = '0';
                    slider.max = '10';
                    slider.value = autoRepair.getPriority(systemName).toString();
                    slider.style.cssText = `
                        flex: 1;
                        height: 4px;
                        background: #333;
                        outline: none;
                        -webkit-appearance: none;
                        appearance: none;
                        pointer-events: auto;
                    `;

                    const valueSpan = document.createElement('span');
                    valueSpan.style.cssText = `
                        min-width: 20px;
                        text-align: right;
                        color: #00ff41;
                    `;
                    valueSpan.textContent = slider.value;

                    // Update priority when slider changes
                    slider.addEventListener('input', (e) => {
                        const newPriority = parseInt(e.target.value);
                        autoRepair.setPriority(systemName, newPriority);
                        valueSpan.textContent = newPriority.toString();
                        
                        // Update display to show changes
                        setTimeout(() => this.updateShipSystemsDisplay(), 100);
                    });

                    sliderDiv.appendChild(slider);
                    sliderDiv.appendChild(valueSpan);

                    systemDiv.appendChild(nameDiv);
                    systemDiv.appendChild(sliderDiv);
                    this.systemsList.appendChild(systemDiv);
                }

                // Total priority display
                const totalDiv = document.createElement('div');
                totalDiv.style.cssText = `
                    margin-top: 8px;
                    padding-top: 4px;
                    border-top: 1px solid #00ff41;
                    font-size: 11px;
                    color: #00aa41;
                `;
                const totalPriority = autoRepair.getTotalPriority();
                totalDiv.textContent = `Total Priority: ${totalPriority}/100`;
                this.systemsList.appendChild(totalDiv);
            }

            formatSystemName(systemName) {
                // Convert system names to display format
                const nameMap = {
                    'shields': 'SHIELDS',
                    'impulse_engines': 'ENGINES',
                    'warp_drive': 'WARP',
                    'weapons': 'WEAPONS',
                    'missile_tubes': 'MISSILES',
                    'sensors': 'SENSORS',
                    'life_support': 'LIFE SUP',
                    'long_range_scanner': 'LR SCANNER',
                    'target_computer': 'TARGETING',
                    'subspace_radio': 'SUBSPACE',
                    'galactic_chart': 'GALACTIC',
                    'hull_plating': 'HULL',
                    'energy_reactor': 'REACTOR',
                    'shield_generator': 'SHIELD GEN',
                    'cargo_hold': 'CARGO'
                };
                return nameMap[systemName] || systemName.toUpperCase();
            }

            setView(viewType) {
                this.view = viewType.toUpperCase();
                this.updateShipSystemsDisplay();
            }

            bindKeyEvents() {
                document.addEventListener('keydown', (event) => {
                    const commandKey = event.key.toLowerCase();

                    // Add Damage Control key binding
                    if (commandKey === 'd') {
                        this.setView('DAMAGE');
                    } else if (commandKey === 'f') {
                        this.setView('FORE');
                    } else if (commandKey === 'a') {
                        this.setView('AFT');
                    }
                });
            }

            update(deltaTime) {
                if (this.ship) {
                    this.ship.update(deltaTime);
                    this.updateShipSystemsDisplay();
                }
            }
        }

        // Initialize ship and interface
        async function initializeTest() {
            try {
                ship = new Ship('heavy_fighter');
                await ship.waitForSystemsInitialized();
                
                starfieldManager = new MockStarfieldManager();
                starfieldManager.ship = ship;
                
                // Start auto-repair system
                if (ship.autoRepairSystem) {
                    ship.autoRepairSystem.start();
                }
                
                console.log('Damage control interface initialized successfully');
                
                // Start update loop
                setInterval(() => {
                    starfieldManager.update(100); // 100ms delta
                }, 100);
                
            } catch (error) {
                console.error('Failed to initialize test:', error);
            }
        }

        // Test functions
        window.damageRandomSystem = function() {
            if (!ship) return;
            
            const systems = Array.from(ship.systems.keys());
            const randomSystem = systems[Math.floor(Math.random() * systems.length)];
            const system = ship.getSystem(randomSystem);
            
            if (system) {
                const damage = 20 + Math.random() * 30; // 20-50% damage
                system.takeDamage(damage);
                console.log(`Damaged ${randomSystem} by ${damage.toFixed(1)}%`);
            }
        };

        window.damageAllSystems = function() {
            if (!ship) return;
            
            for (const [systemName, system] of ship.systems) {
                const damage = 30 + Math.random() * 40; // 30-70% damage
                system.takeDamage(damage);
            }
            console.log('Damaged all systems');
        };

        window.repairAllSystems = function() {
            if (!ship) return;
            
            for (const [systemName, system] of ship.systems) {
                system.repair(1.0); // Full repair
            }
            console.log('Repaired all systems to 100%');
        };

        window.toggleAutoRepair = function() {
            if (!ship || !ship.autoRepairSystem) return;
            
            const newState = ship.autoRepairSystem.toggle();
            console.log(`Auto-repair ${newState ? 'ACTIVATED' : 'DEACTIVATED'}`);
        };

        // Initialize when page loads
        initializeTest();
    </script>
</body>
</html> 